(function(){var a,b;a=function(){function a(){}return a.prototype.start=function(){return exports.ConsoleStyle.infos("Lancement des services d'authentification .."),this.net=require("net"),this.clients=[],this.server=this.net.createServer(function(a){return function(c){return exports.ConsoleStyle.infos("Input connection from "+c.remoteAddress+":"+c.remotePort),a.clients.push(new b(c))}}(this)),this.server.listen(444,function(){return function(){return exports.ConsoleStyle.infos("Les services d'authentification sont en ligne !")}}(this))},a}(),b=function(){function a(a){this.socket=a,this.state=1,this.account=void 0,this.disconnected=!1,this.ip=this.socket.remoteAddress,this.key=exports.Utils.randomString(32),this.socket.on("data",function(a){return function(b){var c,d,e,f,g;for(b=b.toString().replace("\x00","").replace("\n",""),f=b.split("\n"),g=[],d=0,e=f.length;e>d;d++)c=f[d],g.push(""!==c?a.parse(c.trim()):void 0);return g}}(this)),this.socket.on("end",function(a){return function(){return a.onDisconnected()}}(this)),this.send("HC"+this.key)}return a.prototype.disconnect=function(){return exports.ConsoleStyle.infos("Tentative de deconnexion du client "+this.ip),this.socket.destroy(),this.onDisconnected()},a.prototype.onDisconnected=function(){return this.disconnected=!0,exports.Auth.clients.splice(exports.Auth.clients.indexOf(this),1),exports.ConsoleStyle.infos("Client deconnecter !")},a.prototype.send=function(a){return exports.ConsoleStyle.debug("Send data : "+a),this.socket.write(a+"\x00")},a.prototype.parse=function(a){var b,c,d,e;if(!this.disconnected&&(exports.ConsoleStyle.debug("Data incoming : "+a),"Af"!==a&&""!==a.trim()&&0!==a.charCodeAt(0)))switch(this.state){case-1:return this.disconnect();case 1:return this.state="1.29.1"===a?2:-1;case 2:return c=a.split("#"),e=c[0],d=c[1],d=d.substr(1,d.length),b=exports.Utils.cryptPass("test",this.key),exports.ConsoleStyle.debug("Client "+this.ip+" try to login on the account "+e+" and password "+d),exports.Database.getAccountByUsername(e,function(a){return function(b){return void 0!==b?(a.state=3,a.account=b):(exports.ConsoleStyle.error("Le compte '"+e+"' est introuvable"),a.send("AlEx"))}}(this));case 3:return exports.ConsoleStyle.infos("Listage des serveurs ..")}},a}(),exports.Auth=new a}).call(this),function(){var a;a=function(){function a(){}var b;return b=require("colors"),a.drawAscii=function(){return console.log("\n====================================================================".black.bgGreen),console.log("======== Dofus.coffee, a Dofus server written in CoffeeScript ======".black.bgGreen),console.log("============================================= By NightWolf =========\n".black.bgGreen)},a.infos=function(a){return console.log("[LOG]".green+" : "+a)},a.error=function(a){return console.log("[ERROR]".red+" : "+a)},a.debug=function(a){return console.log("[DEBUG]".magenta+" : "+a)},a}(),exports.ConsoleStyle=a}.call(this),function(){var a,b;a=function(){function a(a,b,c,d,e,f,g,h,i){this.id=a,this.username=b,this.password=c,this.pseudo=d,this.secretQuestion=e,this.secretAnswer=f,this.adminLevel=g,this.subscriptionEndDate=h,this.points=i}return a}(),b=function(){function b(){}return b.prototype.run=function(a){var b;return exports.ConsoleStyle.infos("Tentative de connexion a la base de données .."),b=require("mysql"),this.connection=b.createConnection({host:exports.App.config.sql.host,user:exports.App.config.sql.username,password:exports.App.config.sql.password}),this.connection.connect(function(b){return function(c){return c?void a(c):b.connection.query("USE "+exports.App.config.sql.database,function(){return exports.ConsoleStyle.infos("Connecter a la base de données !"),a()})}}(this))},b.prototype.getAccountByUsername=function(b,c){return this.connection.query("SELECT * FROM accounts WHERE username='"+b+"'",function(){return function(b,d){var e,f;return b?(console.log(b),void c(void 0)):d.length>0?(f=d[0],e=new a(f.id,f.username,f.password,f.pseudo,f.secretQuestion,f.secretAnswer,f.adminLevel,f.subscriptionEndDate,f.points),c(e)):c(void 0)}}(this))},b}(),exports.Database=new b,exports.Account=new a}.call(this),function(){var a,b;a=function(){function a(){exports.App=this,exports.ConsoleStyle.drawAscii(),this.loadConfig(),exports.Database.run(function(a){return function(b){return b?void exports.ConsoleStyle.error("Impossible de se connecter a la base de données"):a.loadNetwork()}}(this))}return a.prototype.loadConfig=function(){var a,b,c,d;return exports.ConsoleStyle.infos("Lecture de la configuration .."),c=require("fs"),d=require("js-yaml"),a=c.readFileSync("config.yml","utf8"),b=d.load(a),this.config=b,exports.ConsoleStyle.infos("Configuration chargée avec succées !")},a.prototype.loadNetwork=function(){return exports.Auth.start()},a}(),b=new a}.call(this),function(){}.call(this),function(){var a;a=function(){function a(){}return a.randomString=function(a){var b,c,d,e;for(b="azertyuiopqsdfghjklmwxcvbn",d="",c=e=0;a>=0?a>=e:e>=a;c=a>=0?++e:--e)d+=b.charAt(Math.floor(Math.random()*(b.length-0+1)+0));return d},a.cryptPass=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;for(h=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","0","1","2","3","4","5","6","7","8","9","-","_"],g="",i=l=0,m=a.lenth;m>=0?m>=l:l>=m;i=m>=0?++l:--l)k=a.charAt(i),j=b.charAt(i),f=k/16,c=k%16,d=(f+j)%h.length,e=(c+j)%h.length,g+=h[d],g+=h[e];return g},a}(),exports.Utils=a}.call(this);